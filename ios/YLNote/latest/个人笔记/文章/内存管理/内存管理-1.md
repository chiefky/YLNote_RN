

# å¼•ç”¨è®¡æ•°åŸç†

## 1.1 å¼•ç”¨è®¡æ•°å­˜å‚¨ä½ç½®

å¼•ç”¨è®¡æ•°çš„å­˜å‚¨ä½ç½®åˆ†ä¸‰ç§æƒ…å†µï¼š

* ç‰¹ä¾‹ï¼šTaggedPointerå¯¹è±¡ï¼šè‹¹æœä¼šç›´æ¥å°†å…¶æŒ‡é’ˆå€¼ä½œä¸ºå¼•ç”¨è®¡æ•°è¿”å›
* å¼€å¯isaä¼˜åŒ–çš„å¯¹è±¡ï¼ˆNONPOINTER_ISA == 1ï¼‰ï¼šå¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨isa_tä¸­çš„`shiftcls`å­—æ®µä¸­
* æ™®é€šå¯¹è±¡ï¼ˆNONPOINTER_ISA == 0ï¼‰ and  `shiftcls`å­—æ®µè¶Šç•Œçš„å¯¹è±¡ï¼š å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨SideTableä¸­ï¼Œé€šè¿‡å¯¹è±¡çš„å†…å­˜åœ°å€æ‰¾åˆ°æ•£åˆ—è¡¨å‘¨è¾¹ä¿å­˜çš„`retaincount`ï¼ˆæœ€ç»ˆå€¼ï¼š`shiftcls` + `retaincount` + 1ï¼‰

## 1.2 å¼•ç”¨è®¡æ•°ç®¡ç†

[å¼•ç”¨è®¡æ•°](https://link.juejin.cn/?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%2F10205507%3Ffr%3Daladdin)æ˜¯è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œæ˜¯æŒ‡å°†èµ„æºï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€å†…å­˜æˆ–ç£ç›˜ç©ºé—´ç­‰ç­‰ï¼‰çš„è¢«å¼•ç”¨æ¬¡æ•°ä¿å­˜èµ·æ¥ï¼Œå½“è¢«å¼•ç”¨æ¬¡æ•°å˜ä¸ºé›¶æ—¶å°±å°†å…¶é‡Šæ”¾çš„è¿‡ç¨‹ã€‚

å½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºå¹¶åœ¨å †åŒºç”³è¯·å†…å­˜æ—¶ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º1ï¼›å½“å…¶ä»–çš„å¯¹è±¡éœ€è¦æŒæœ‰è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå°±éœ€è¦å°†è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ 1ï¼›å½“å…¶ä»–çš„å¯¹è±¡ä¸å†éœ€è¦æŒæœ‰è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œéœ€è¦å°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡1ï¼›å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œå¯¹è±¡çš„å†…å­˜å°±ä¼šç«‹å³é‡Šæ”¾ï¼Œå¯¹è±¡é”€æ¯ã€‚

å¼•ç”¨è®¡æ•°å‘ç”Ÿå˜åŒ–çš„æ“ä½œæœ‰å“ªäº›ï¼š

- è°ƒç”¨`allocã€newã€copyã€mutableCopy`åç§°å¼€å¤´çš„æ–¹æ³•åˆ›å»ºçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ 1ã€‚
- è°ƒç”¨`retain`æ–¹æ³•æ—¶ï¼Œè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ 1ã€‚
- è°ƒç”¨`release`æ–¹æ³•æ—¶ï¼Œè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡1ã€‚
- `autorelease`æ–¹æ³•ä¸æ”¹å˜è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ï¼Œåªæ˜¯å°†å¯¹è±¡æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ã€‚
- `retainCount`æ–¹æ³•è¿”å›è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼ã€‚



# å†…å­˜ç®¡ç†æ–¹æ¡ˆ

å…ˆç®€å•äº†è§£å‡ ä¸ªæ¦‚å¿µï¼š

* TaggedPointer ï¼šå†…ç½®Tagged Pointer**æŒ‡é’ˆ**ä¸­åŒ…å«äº†å½“å‰å¯¹è±¡çš„åœ°å€ã€ç±»å‹ã€å…·ä½“æ•°å€¼ã€‚

* nonpointer ï¼š isa_t è”åˆä½“çš„ç¬¬ä¸€ä½ï¼›0ï¼Œä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€classã€meta-classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼›1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯ï¼›

* SideTableï¼š åœ¨OCä¸­æ‰®æ¼”è¿™ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ã€‚åœ¨runtimeä¸­ï¼Œé€šè¿‡`SideTable`æ¥ç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä»¥åŠweakå¼•ç”¨ã€‚åŒæ—¶ï¼Œç³»ç»Ÿä¸­ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„`SideTables`ï¼Œè¿™æ˜¯ä¸€ä¸ª`SideTable`çš„é›†åˆã€‚

  >  **SideTable** ä¸»è¦å­˜æ”¾äº†OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆRefcountMapï¼‰å’Œå¼±å¼•ç”¨ç›¸å…³ä¿¡æ¯ï¼ˆweak_table_tï¼‰ã€‚
  >
  >  * RefcountMapï¼šä»¥DisguisedPtr<objc_object>ä¸ºkeyçš„hashè¡¨ï¼Œç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°(ä»…åœ¨æœªå¼€å¯isaä¼˜åŒ– æˆ– åœ¨isaä¼˜åŒ–æƒ…å†µä¸‹isa_tçš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°)ã€‚
  >  * weak_table_tï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨ã€‚æ˜¯OC weakåŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚

* AssociationsHashMapï¼šå­˜æ”¾å¯¹è±¡çš„å…³è”å¯¹è±¡mapçš„mapï¼ˆkeyä¸ºä¼ å…¥çš„objectï¼Œvalueä¸ºmapï¼Œä¹Ÿå°±æ˜¯ObjectAssociationMapï¼‰

ä»¥ä¸Š4ç§æ ‡è®°æˆ–è€…æ˜¯ç»“æ„ä»£è¡¨äº†4ç±»æ•°æ®çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼›ä¸‹é¢è¯¦ç»†æ¢³ç†ï¼›

## TaggedPointer

> > ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer?
> > å‡è®¾è¦å­˜å‚¨ä¸€ä¸ªNSNumberå¯¹è±¡ï¼Œå…¶å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¿™ä¸ªæ•´æ•°åªæ˜¯ä¸€ä¸ªNSIntegerçš„æ™®é€šå˜é‡ï¼Œåœ¨64ä½CPUä¸‹æ˜¯å 8ä¸ªå­—èŠ‚çš„ã€‚1ä¸ªå­—èŠ‚æœ‰8ä½ï¼Œå¦‚æœæˆ‘ä»¬å­˜å‚¨ä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œä¼šå‡ºç°å¾ˆå¤šä½éƒ½æ˜¯0çš„æƒ…å†µï¼Œè¿™æ ·å°±é€ æˆäº†å†…å­˜æµªè´¹ï¼Œè‹¹æœä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†taggedPointerçš„æ¦‚å¿µã€‚
> >
> > ä»¥NSNumberä¸ºğŸŒ°ï¼Œå¯¹è±¡å ç”¨å†…å­˜ç©ºé—´æƒ…å†µï¼š
> >
> > arm64ä¹‹å‰ï¼šæŒ‡é’ˆï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+ NSNumberå¯¹è±¡ï¼ˆ16ä¸ªå­—èŠ‚ å†…å­˜å¯¹é½ï¼‰
> >
> > arm64ä¹‹åï¼šTaggedPointeræŒ‡é’ˆï¼ˆåªå 8å­—èŠ‚ï¼‰
>
> 
>
> - **Tagged Pointer**æ˜¯è‹¹æœä¸ºäº†è§£å†³32ä½CPUåˆ°64ä½CPUçš„è½¬å˜å¸¦æ¥çš„å†…å­˜å ç”¨å’Œæ•ˆç‡é—®é¢˜ï¼Œé’ˆå¯¹**NSNumberã€NSDate**ä»¥åŠéƒ¨åˆ†**NSString**çš„å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆã€‚
> - **Tagged PointeræŒ‡é’ˆ**çš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒ**ä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡**äº†ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æ™®é€šå˜é‡è€Œå·²ã€‚æ‰€ä»¥ï¼Œå®ƒçš„**å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼ˆè€Œæ˜¯åœ¨æ ˆä¸Šï¼‰ï¼Œä¹Ÿ**ä¸éœ€è¦mallocå’Œfree**ã€‚
> - **Tagged PointeræŒ‡é’ˆ**ä¸­åŒ…å«äº†å½“å‰å¯¹è±¡çš„åœ°å€ã€ç±»å‹ã€å…·ä½“æ•°å€¼ã€‚å› æ­¤Tagged PointeræŒ‡é’ˆåœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€3å€çš„æ•ˆç‡ï¼Œåˆ›å»ºæ—¶æ¯”æ™®é€šéœ€è¦**malloc**è·Ÿ**free**çš„ç±»å‹**å¿«106å€**ã€‚
>
> TaggedPointeræ··æ·†åŸç†ï¼š
>
> æ··æ·†åŸç†ï¼šä½¿ç”¨ä¸€ä¸ªéšæœºæ•°`objc_debug_taggedpointer_obfuscator`å¯¹çœŸæ­£çš„å†…å­˜åœ°å€å¼‚æˆ–æ“ä½œã€‚æ ¹æ®å¼‚æˆ–è¿ç®—çš„ç‰¹æ€§ï¼Œa^b^b=aï¼Œå› æ­¤åªéœ€è¦å°†æ··æ·†åçš„åœ°å€å†ä¸`objc_debug_taggedpointer_obfuscator`å¼‚æˆ–ä¸€æ¬¡å°±èƒ½å¤Ÿå®Œæˆåæ··æ·†ã€‚
>
> **Tagged Pointerå†…å­˜ç»“æ„**
>
> <img src="../images/å†…å­˜ç®¡ç†_taggedPointer_64.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;" />
>
> <img src="../images/å†…å­˜ç®¡ç†_taggedPointer_64_2.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;" />
>
> ä¸macOSä¸åŒï¼ŒiOSç³»ç»Ÿé‡‡ç”¨ `MSB`ï¼ˆ`Most Significant Bit`ï¼Œå³æœ€é«˜æœ‰æ•ˆä½ï¼‰ä¸º`Tagged Pointer`æ ‡å¿—ä½ã€‚
>
> **å„bitå«ä¹‰è§£é‡Š**
>
> * _OBJC_TAG_MASK: å 1bitï¼Œæ˜¯`Tagged Pointer`æ ‡å¿—ä½ï¼Œ1æ„å‘³ç€è¯¥åœ°å€æ˜¯`Tagged Pointer`ï¼Œ0åˆ™ä¸æ˜¯ã€‚
>
> * Extended_Tag_Indexï¼šå 8bitï¼Œåªæœ‰å½“Tag_Index=7çš„æ—¶å€™æ‰å­˜åœ¨ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨äºæ‰©å±•çš„æ ‡å¿—ä½ï¼Œä¼šé¢å¤–å ç”¨8ä½æ¥å­˜å‚¨æ‰©å±•çš„Tag Indexã€‚ç±»æ ‡è¯†çš„åŸºæœ¬ç±»å‹å’Œæ‰©å±•ç±»å‹æˆ‘ä»¬å¯ä»¥åœ¨`Runtime`æºç ä¸­çš„`objc_tag_index_t`æŸ¥åˆ°ï¼š
>
>   <img src="/Users/tangh/Library/Application Support/typora-user-images/image-20210806165118167.png" style="zoom:30%;" />
>
> * Tag_Indexï¼šå 3bitï¼Œæ˜¯ç±»æ ‡å¿—ä½ï¼Œå¯ä»¥åœ¨`Runtime`æºç ä¸­æŸ¥çœ‹`NSNumber`ã€`NSDate`ã€`NSString`ç­‰ç±»çš„æ ‡å¿—ä½ã€‚
>
> * Payloadï¼šå¯¹NSNumberè€Œè¨€ï¼Œæœ€å¤šå 56bitï¼Œæœ€å°‘å 48bitï¼ˆå–å†³äºTag Indexæ˜¯å¦ä¸ºextended tag indexï¼‰ï¼Œå­˜å‚¨å…·ä½“çš„æ•°å€¼ã€‚
>
> * Type_Index: å 4bitï¼Œä»£è¡¨NSNumberå…·ä½“çš„æ•°æ®ç±»å‹ï¼Œå…·ä½“çš„å¯¹åº”å…³ç³»ï¼š
>
>   | Type_Index | å¯¹åº”æ•°æ®ç±»å‹                                                 |
>   | ---------- | ------------------------------------------------------------ |
>   | 0          | char                                                         |
>   | 1          | usigned char, short                                          |
>   | 2          | unsigned short,int                                           |
>   | 3          | unsigned int,NSInteger,NSUInteger,long,unsigned long,long long,unsigned long long |
>   | 4          | float                                                        |
>   | 5          | double                                                       |
>
>   
>
>   ç»“è®ºï¼š`Tagged Pointer`å¯è¡¨ç¤ºçš„æ•°å­—èŒƒå›´æ˜¯-2^55+1 ~ 2^55-1ï¼Œå¯¹äºè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ•°å­—ï¼ŒNSNumberä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæ™®é€šçš„å†…å­˜åˆ†é…åœ¨å †ä¸Šçš„OCå¯¹è±¡ã€‚
>
>   **å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged Pointer**
>
>   åœ¨  [objc runtimeæºç ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKanthine%2FSourceCode%2Fblob%2F51fd88340a1d76047dcb8bb02e47f14482d00706%2Fobjc4-750%2Fruntime%2Fobjc-internal.h)ä¸­æ‰¾åˆ°äº† `_objc_isTaggedPointer()`çš„å®ç°ï¼š
>
>   ```cpp
>   static inline bool _objc_isTaggedPointer(const void * _Nullable ptr){
>       //å°†ä¸€ä¸ªæŒ‡é’ˆåœ°å€å’Œ _OBJC_TAG_MASK å¸¸é‡åš & è¿ç®—ï¼šåˆ¤æ–­è¯¥æŒ‡é’ˆçš„æœ€é«˜ä½æˆ–è€…æœ€ä½ä½ä¸º 1ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå°±æ˜¯ Tagged Pointerã€‚
>       return ((uintptr_t)ptr & _OBJC_TAG_MASK) == _OBJC_TAG_MASK;
>   }
>   ```
>   
>
> `_OBJC_TAG_MASK` çš„å®šä¹‰ï¼š
>
> ```cpp
>   #if OBJC_MSB_TAGGED_POINTERS //MSB é«˜ä½ä¼˜å…ˆ
>   #   define _OBJC_TAG_MASK (1UL<<63) //Tagged Pointer æŒ‡é’ˆ
>   #else //LSB ä½ä½ä¼˜å…ˆ
>   #   define _OBJC_TAG_MASK 1UL //Tagged Pointer æŒ‡é’ˆ
>   #endif
> ```
>
>   å› æ­¤ `ptr & _OBJC_TAG_MASK` æŒ‰ä½ä¸è¿ç®—ä¹‹åå¦‚æœåˆ¤æ–­æ ‡å¿—ä½ä¸º1åˆ™è¯¥æŒ‡é’ˆæ˜¯`Tagged Pointer` ã€‚

**é™„**ï¼š**tagged Pointer** é’ˆå¯¹ **obj_msg_send** çš„å¤„ç†

â€‹	â€¢	å¯¹äºå†…ç½®Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜å››ä½ä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ï¼›

â€‹	â€¢	å¯¹äºè‡ªå®šä¹‰æ‰©å±•Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜52ä½åˆ°59ä½è¿™8ä½bitä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_ext_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ã€‚

## nonpointer

> - `0ï¼Œ`ä»£è¡¨æ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€`Class`ã€`Meta-Class`å¯¹è±¡çš„å†…å­˜åœ°å€ ---- ï¼ˆ**<font color=red>æœªå¼€å¯isaä¼˜åŒ–</font>** ï¼‰
>
>   å¦‚æœnonpointerä¸º0ï¼Œä»£è¡¨raw isaï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç»“æ„ä½“çš„éƒ¨åˆ†ï¼Œè®¿é—®å¯¹è±¡çš„ isa ä¼šç›´æ¥è¿”å›ä¸€ä¸ªæŒ‡å‘ cls çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åœ¨ iPhone è¿ç§»åˆ° 64 ä½ç³»ç»Ÿä¹‹å‰æ—¶ isa çš„ç±»å‹ã€‚
>
> - 1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ -----ï¼ˆ<font color=red>**å¼€å¯isaä¼˜åŒ–**</font> ï¼‰

## TODOï¼šSideTable&weakåº•å±‚åŸç†

> æ¥çœ‹çœ‹SideTableçš„å®šä¹‰ï¼š
>
> ```objc
> struct SideTable {
>     spinlock_t slock;
>     RefcountMap refcnts;
>     weak_table_t weak_table;
> }
> 
> ```
>
> SideTableçš„å®šä¹‰å¾ˆæ¸…æ™°ï¼Œæœ‰ä¸‰ä¸ªæˆå‘˜:
>
> > - **spinlock_t slock**ï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¸Šé”/è§£é” SideTableã€‚
> > - **RefcountMap refcnts**ï¼šç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°çš„ `hashè¡¨`(ä»…åœ¨æœªå¼€å¯isaä¼˜åŒ–æˆ–åœ¨isaä¼˜åŒ–æƒ…å†µä¸‹isa_tçš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°ï¼Œ<font color="red">**æœªæº¢å‡ºæ—¶æ˜¯æ”¾åœ¨isa_tä¸‹çš„extra_rcå­—æ®µä¸­**</font>)ã€‚
> > - **weak_table_t weak_table**ï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨ã€‚æ˜¯OCä¸­weakåŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚



# AutoreleasePoolç®€ä»‹



## TODOï¼šruntimeå†…å­˜ç®¡ç†ä¼˜åŒ–

